<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Đơn Hàng</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }

        h1 {
            font-weight: bold;
            color: #051F96;
        }

        /* Chia màn hình thành 2 phần */
        .container {
            position: relative;
            /* Để phần tử con có thể định vị theo container */
            width: 100%;
            margin-top: 20px;
        }

        .left-container {
            position: absolute;
            top: -60px;
            right: 0;
            width: 280px;
            z-index: 999;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            opacity: 0.7;
            transition: opacity 0.3s ease, left 0.3s ease;
            display: none;
        }

        /* Khi nhấn nút, hiển thị left-container */
        .left-container.show {
            display: block;
            opacity: 1;
            right: 0;
            /* Đảm bảo left-container nằm trong vị trí ban đầu */
        }

        /* Nút hiển thị lọc */
        .toggle-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #051F96;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 999;
        }

        .toggle-button:hover {
            background-color: #4CAF50;
        }

        /* Phần bên phải: chứa dữ liệu */
        .right-container {
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 5px 5px 5px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 100%;
            /* Chiếm phần còn lại của chiều rộng */
        }

        /* Table style */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            display: block;
            max-height: 100vh;
            overflow-x: auto;
            overflow-y: auto;
        }

        th {
            position: sticky;
            top: 0;
            z-index: 1;
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            max-height: 24px;
            overflow: hidden;
            background-color: #051F96;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        tr:not(:first-child) {
            height: 24px;
        }

        td {
            padding: 0 12px;
            border: 1px solid #ddd;
            text-align: left;
            height: 24px;
            line-height: 24px;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: #fff;
            color: #555;
        }

        td:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }

        /* Cập nhật chiều cao cố định cho ô trong bảng */
        td,
        tr:not(:first-child) td {
            line-height: 24px;
            /* Căn chỉnh nội dung theo chiều cao */
            vertical-align: middle;
            /* Đảm bảo nội dung ở giữa */
        }

        table td:nth-child(1),
        table td:nth-child(2),
        table td:nth-child(3),
        table td:nth-child(4),
        table td:nth-child(14),
        table td:nth-child(15),
        table td:nth-child(16),
        table td:nth-child(17) {
            color: #4CAF50;
            font-weight: bold;
        }

        table td:nth-child(3),
        table td:nth-child(4),
        table td:nth-child(5),
        table td:nth-child(8),
        table td:nth-child(9) {
            text-wrap: nowrap;
        }

        table td:nth-child(18),
        table th:nth-child(18),
        table td:nth-child(19),
        table th:nth-child(19),
        table td:nth-child(20),
        table th:nth-child(20) {
            display: none;
        }

        .filter-container {
            margin-bottom: 30px;
        }

        .filter-container label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #051F96;
        }

        .filter-container select {
            padding: 12px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: #fff;
            color: #333;
            font-weight: 500;
        }

        .filter-container select:hover {
            border-color: #4CAF50;
        }

        .filter-container select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .left-container {
                width: 100%;
                margin-bottom: 20px;
            }

            .right-container {
                width: 100%;
            }
        }

        .time-container {
            position: absolute;
            top: 30px;
            display: flex;
            align-items: left;
            justify-content: left;
            gap: 10px;
            font-weight: bold;
            color: red;
        }

        .filter-results-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
            color: #051F96;
            margin-top: 15px;
        }

        .clock-icon {
            font-size: 20px;
            color: red;
            animation: blink 1s infinite;
        }

        /* Hiệu ứng nhấp nháy */
        @keyframes blink {
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            0% {
                opacity: 1;
            }
        }
    </style>
    <!-- Thêm Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>
    <h1>
        <center>KẾ HOẠCH SẢN XUẤT REALTIME</center>
    </h1>
    <div class="time-container">
        <!-- Biểu tượng đồng hồ bên trái -->
        <i class="fas fa-clock clock-icon"></i>
        <!-- Thời gian -->
        <div id="current-time"></div>
        <!-- Biểu tượng đồng hồ bên phải -->
        <i class="fas fa-clock clock-icon"></i>
    </div>
    <div class="filter-results-container">
        <i class="fas fa-city"></i>
        <div id="filter-results-region">Xưởng sản xuất: Tất cả</div>
        <b> </b><b> </b><b> </b><b> </b><b> </b>
        <i class="fas fa-store-alt"></i>
        <div id="filter-results-generaltrade">Đơn vị phụ trách: Tất cả</div>
        <b> </b><b> </b><b> </b><b> </b><b> </b>
        <i class="fab fa-steam-square"></i>
        <div id="filter-results-status">Tiến độ: Tất cả</div>
        <b> </b><b> </b><b> </b><b> </b><b> </b>
        <i class="fas fa-list-ol"></i>
        <div id="status-count"></div>
    </div>
    <button id="toggleFilterButton" class="toggle-button">Hiển thị Lọc</button>
    <!-- Chia màn hình thành 2 phần -->
    <div class="container">
        <!-- Phần bên trái chứa bộ lọc -->
        <div class="left-container">
            <div class="filter-container">

                <!-- Bộ lọc Khu vực -->
                <label for="region-filter">Xưởng sản xuất: </label><br>
                <select id="region-filter" size="4">
                    <option value="">Tất cả</option>
                    <option value="Hà Nội">Hà Nội</option>
                    <option value="Long An">Long An</option>
                </select><br>

                <!-- Bộ lọc Đơn vị phụ trách -->
                <label for="generaltrade-filter">Đơn vị phụ trách: </label><br>
                <select id="generaltrade-filter" size="4">
                    <option value="">Tất cả</option>
                </select><br>

                <!-- Bộ lọc Tiến độ -->
                <label for="status-filter">Tiến độ: </label><br>
                <select id="status-filter" size="10">
                    <option value="">Tất cả</option>
                    <option value="1. Không được duyệt sản xuất">1. Không được duyệt sản xuất</option>
                    <option value="2. Chờ duyệt sản xuất">2. Chờ duyệt sản xuất</option>
                    <option value="3. Chờ sản xuất">3. Chờ sản xuất</option>
                    <option value="4. Đang sản xuất">4. Đang sản xuất</option>
                    <option value="5. Tạm dừng sản xuất">5. Tạm dừng sản xuất</option>
                    <option value="6. Đã nhập kho thành phẩm">6. Đã nhập kho thành phẩm</option>
                    <option value="7. Đã xuất kho thành phẩm">7. Đã xuất kho thành phẩm</option>
                    <option value="8. Đã nhận hàng">8. Đã nhận hàng</option>
                </select>
            </div>
        </div>

        <!-- Phần bên phải chứa dữ liệu -->
        <div class="right-container">
            <div id="data-container">
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <script>

        // Hàm để cập nhật ngày giờ
        function updateCurrentTime() {
            const currentTimeElement = document.getElementById('current-time');
            const now = new Date();
            const formattedTime = now.toLocaleString('vi-VN', { hour12: false }); // Định dạng thời gian theo chuẩn Việt Nam

            currentTimeElement.textContent = formattedTime; // Cập nhật ngày giờ vào phần tử
        }

        // Cập nhật thời gian ngay khi trang được tải
        updateCurrentTime();

        // Cập nhật thời gian mỗi giây
        setInterval(updateCurrentTime, 1000);

        // Đảm bảo mã chỉ chạy sau khi DOM đã được tải
        document.addEventListener('DOMContentLoaded', function () {
            const toggleButton = document.getElementById('toggleFilterButton');
            const leftContainer = document.querySelector('.left-container');

            if (toggleButton && leftContainer) {  // Kiểm tra sự tồn tại của phần tử
                toggleButton.addEventListener('click', function () {
                    if (leftContainer.classList.contains('show')) {
                        leftContainer.classList.remove('show');
                        toggleButton.textContent = 'Hiển thị Lọc';
                    } else {
                        leftContainer.classList.add('show');
                        toggleButton.textContent = 'Ẩn Lọc';
                    }
                });
            }
        });


        let allData = [];
        const selectedColumns = [67, 72, 1, 66, 4, 13, 17, 0, 60, 63, 74, 25, 84, 77, 81, 82, 83, 78, 76, 5];
        const columnNames = {
            67: 'Thời gian tiếp nhận',
            72: 'Hạn giao hàng',
            1: 'Mã báo giá',
            66: 'Mã đơn hàng',
            4: 'Nhân sự bán',
            13: 'Tên người liên hệ',
            17: 'Địa chỉ chi tiết',
            0: 'Hình thức bán',
            60: 'Loại đơn hàng',
            63: 'Lưu ý',
            74: 'Phiếu cắt',
            25: 'Số bộ',
            84: 'Chủng loại sản phẩm',
            77: 'Ngày sản xuất',
            81: 'Ngày nhập kho',
            82: 'Ngày xuất kho',
            83: 'Ngày nhận hàng',
            78: 'Tiến độ',
            76: 'Khu vực',
            5: 'Đơn vị phụ trách'
        };

        // Hàm để lấy dữ liệu từ cột "Đơn vị phụ trách" và thêm vào bộ lọc
        function updateGeneralTradeFilterOptions() {
            const generalTradeIndex = selectedColumns.indexOf(5); // Tìm chỉ số của cột "Đơn vị phụ trách" (5 là key trong columnNames)
            const generalTradeFilterElement = document.getElementById('generaltrade-filter');

            // Lấy danh sách giá trị duy nhất từ cột "Đơn vị phụ trách"
            const generalTradeValues = [...new Set(allData.map(row => row[generalTradeIndex]).filter(value => value))];

            // Xóa tất cả các option hiện tại (trừ option "Tất cả")
            generalTradeFilterElement.innerHTML = '<option value="">Tất cả</option>';

            // Thêm các giá trị vào bộ lọc
            generalTradeValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                generalTradeFilterElement.appendChild(option);
            });
        }

        function updateStatusCount() {
            const counts = {};

            // Filter data based on selected criteria
            const selectedStatus = document.getElementById('status-filter').value;
            const selectedRegion = document.getElementById('region-filter').value;
            const selectedGeneralTrade = document.getElementById('generaltrade-filter').value;

            const filteredData = allData.filter(row => {
                const progress = row[17];
                const region = row[18];
                const generalTrade = row[19];

                return (
                    (!selectedStatus || progress === selectedStatus) &&
                    (!selectedRegion || region === selectedRegion) &&
                    (!selectedGeneralTrade || generalTrade === selectedGeneralTrade)
                );
            });

            // Count occurrences of each combination of status, region, and general trade
            filteredData.forEach(row => {
                const progress = row[17];
                const region = row[18];
                const generalTrade = row[19];
                const key = `${progress}-${region}-${generalTrade}`;

                counts[key] = (counts[key] || 0) + 1;
            });

            // Render the count based on the selected filters
            const statusCountElement = document.getElementById('status-count');

            if (selectedStatus && selectedRegion && selectedGeneralTrade) {
                const selectedKey = `${selectedStatus}-${selectedRegion}-${selectedGeneralTrade}`;
                statusCountElement.textContent = `Số đơn: ${counts[selectedKey] || 0}`;
            } else if (selectedStatus && selectedRegion) {
                const total = Object.keys(counts)
                    .filter(key => key.startsWith(`${selectedStatus}-${selectedRegion}-`))
                    .reduce((sum, key) => sum + counts[key], 0);
                statusCountElement.textContent = `Số đơn: ${total}`;
            } else if (selectedStatus && selectedGeneralTrade) {
                const total = Object.keys(counts)
                    .filter(key => key.startsWith(`${selectedStatus}-`) && key.endsWith(`-${selectedGeneralTrade}`))
                    .reduce((sum, key) => sum + counts[key], 0);
                statusCountElement.textContent = `Số đơn: ${total}`;
            } else if (selectedRegion && selectedGeneralTrade) {
                const total = Object.keys(counts)
                    .filter(key => key.endsWith(`-${selectedRegion}-${selectedGeneralTrade}`))
                    .reduce((sum, key) => sum + counts[key], 0);
                statusCountElement.textContent = `Số đơn: ${total}`;
            } else if (selectedStatus) {
                const total = Object.keys(counts)
                    .filter(key => key.startsWith(`${selectedStatus}-`))
                    .reduce((sum, key) => sum + counts[key], 0);
                statusCountElement.textContent = `Số đơn: ${total}`;
            } else if (selectedRegion) {
                const total = Object.keys(counts)
                    .filter(key => key.endsWith(`-${selectedRegion}`))
                    .reduce((sum, key) => sum + counts[key], 0);
                statusCountElement.textContent = `Số đơn: ${total}`;
            } else if (selectedGeneralTrade) {
                const total = Object.keys(counts)
                    .filter(key => key.endsWith(`-${selectedGeneralTrade}`))
                    .reduce((sum, key) => sum + counts[key], 0);
                statusCountElement.textContent = `Số đơn: ${total}`;
            } else {
                const total = filteredData.length;
                statusCountElement.textContent = `Số đơn: ${total}`;
            }
        }

        async function fetchData() {
            console.log("Hàm fetchData đang chạy...");
            const currentRegion = document.getElementById('region-filter').value;
            const currentGeneralTrade = document.getElementById('generaltrade-filter').value;
            const currentStatus = document.getElementById('status-filter').value;

            try {
                const response = await fetch('/data');
                const result = await response.json();

                if (result.data) {
                    allData = result.data.slice(1).map(row => selectedColumns.map(index => row[index] || ''));
                    updateGeneralTradeFilterOptions(); // Cập nhật bộ lọc Đơn vị phụ trách
                    filterData(); // Hiển thị tất cả dữ liệu ban đầu
                    updateStatusCount(); // Cập nhật tổng số dòng

                    // Reapply the filter values
                    document.getElementById('region-filter').value = currentRegion;
                    document.getElementById('generaltrade-filter').value = currentGeneralTrade;
                    document.getElementById('status-filter').value = currentStatus;

                    // Optionally, reapply the filtering function if needed
                    filterData(); // Call filterData to apply the filters again
                    updateFilterResults();
                } else {
                    document.getElementById('data-container').innerHTML = '<p>Không có dữ liệu.</p>';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('data-container').innerHTML = '<p>Lỗi khi tải dữ liệu.</p>';
            }
        }

        function updateFilterResults() {
            const selectedStatus = document.getElementById('status-filter').value;
            const selectedRegion = document.getElementById('region-filter').value;
            const selectedGeneralTrade = document.getElementById('generaltrade-filter').value;

            // Tạo thông tin kết quả lọc
            let resultTextRegion = '';
            if (selectedRegion) {
                resultTextRegion += `Xưởng sản xuất: ${selectedRegion}`;
            } else {
                resultTextRegion += 'Xưởng sản xuất: Tất cả';
            }
            // Cập nhật phần tử hiển thị kết quả lọc
            document.getElementById('filter-results-region').textContent = resultTextRegion;

            let resultTextStatus = '';
            if (selectedStatus) {
                resultTextStatus += `Tiến độ: ${selectedStatus}`;
            } else {
                resultTextStatus += 'Tiến độ: Tất cả';
            }
            // Cập nhật phần tử hiển thị kết quả lọc
            document.getElementById('filter-results-status').textContent = resultTextStatus;

            let resultTextGeneralTrade = '';
            if (selectedGeneralTrade) {
                resultTextGeneralTrade += `Đơn vị phụ trách: ${selectedGeneralTrade}`;
            } else {
                resultTextGeneralTrade += 'Đơn vị phụ trách: Tất cả';
            }
            // Cập nhật phần tử hiển thị kết quả lọc
            document.getElementById('filter-results-generaltrade').textContent = resultTextGeneralTrade;

            // Cập nhật số lượng đơn hàng đã lọc
            updateStatusCount();
        }

        document.getElementById('status-filter').addEventListener('change', function () {
            filterData(); // Lọc dữ liệu theo Tiến độ
            updateStatusCount(); // Cập nhật số dòng theo Tiến độ đã chọn
            updateFilterResults(); // Cập nhật kết quả lọc
        });

        document.getElementById('region-filter').addEventListener('change', function () {
            filterData(); // Lọc dữ liệu theo Khu vực
            updateStatusCount(); // Cập nhật số dòng theo Khu vực đã chọn
            updateFilterResults(); // Cập nhật kết quả lọc
        });

        document.getElementById('generaltrade-filter').addEventListener('change', function () {
            filterData(); // Lọc dữ liệu theo Khu vực
            updateStatusCount(); // Cập nhật số dòng theo Khu vực đã chọn
            updateFilterResults(); // Cập nhật kết quả lọc
        });


        function renderData(data, headerRow) {
            const container = document.getElementById('data-container');
            container.innerHTML = '';

            const table = document.createElement('table');

            const header = headerRow.map(cell => `<th>${cell}</th>`).join('');
            const headerElement = document.createElement('tr');
            headerElement.innerHTML = header;
            table.appendChild(headerElement);

            // Nhóm dữ liệu theo ngày
            const groupedData = data.reduce((groups, row) => {
                const datePart = row[0]?.split(' ')[0]; // Lấy phần ngày từ "Thời gian tiếp nhận"
                if (datePart) {
                    if (!groups[datePart]) {
                        groups[datePart] = [];
                    }
                    groups[datePart].push(row);
                }
                return groups;
            }, {});

            // Sắp xếp nhóm theo ngày (theo thứ tự thời gian)
            const sortedGroupKeys = Object.keys(groupedData).sort((a, b) => {
                const dateA = new Date(a.split('/').reverse().join('-'));
                const dateB = new Date(b.split('/').reverse().join('-'));
                return dateA - dateB;
            });

            // Render dữ liệu theo nhóm
            sortedGroupKeys.forEach(datePart => {
                // Thêm dòng tiêu đề nhóm
                const groupRow = document.createElement('tr');
                groupRow.innerHTML = `<td colspan="${headerRow.length}" style="color: red"><b>Ngày tiếp nhận ${datePart}</b></td>`;
                table.appendChild(groupRow);

                // Thêm các dòng dữ liệu trong nhóm
                groupedData[datePart].forEach(row => {
                    const rowElement = document.createElement('tr');

                    rowElement.innerHTML = row.map((cell, index) => {
                        // Nếu cột là "Thời gian tiếp nhận" (cột có chỉ số 67)
                        if (index === 0) { // Chỉ số cột trong dữ liệu hiển thị
                            // Kiểm tra nếu cell chứa giá trị hợp lệ
                            if (cell) {
                                const timePart = cell.split(' ')[1]; // Lấy phần thời gian
                                return `<td>${timePart || cell}</td>`; // Trả về phần thời gian hoặc giá trị ban đầu nếu không hợp lệ
                            }
                            return `<td>${cell}</td>`; // Trả về giá trị ban đầu nếu không hợp lệ
                        }
                        return `<td>${cell}</td>`; // Nếu không phải là cột Thời gian tiếp nhận
                    }).join('');

                    table.appendChild(rowElement);
                });
            });

            container.appendChild(table);
        }

        function filterData() {
            const selectedStatus = document.getElementById('status-filter').value;
            const selectedRegion = document.getElementById('region-filter').value;
            const selectedGeneralTrade = document.getElementById('generaltrade-filter').value;

            const filteredData = allData.filter(row => {
                const progress = row[17]; // Cột Tiến độ
                const region = row[18]; // Cột Khu vực
                const generalTrade = row[19]; // Cột Đơn vị phụ trách
                const matchesStatus = !selectedStatus || progress === selectedStatus;
                const matchesRegion = !selectedRegion || region === selectedRegion;
                const matchesGeneralTrade = !selectedGeneralTrade || generalTrade === selectedGeneralTrade;
                return matchesStatus && matchesRegion && matchesGeneralTrade;
            });

            renderData(filteredData, selectedColumns.map(index => columnNames[index] || `Cột ${index + 1}`));
        }

        // Cập nhật lại dữ liệu sau mỗi 30 giây
        setInterval(fetchData, 15000); // Lặp lại mỗi 15 giây

        fetchData();
    </script>
</body>

</html>